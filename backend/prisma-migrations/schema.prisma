generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id                     String                 @id @default(uuid())
  name                   String                 @unique
  address                String
  phone                  String?
  is_active              Boolean                @default(true)
  created_at             DateTime               @default(now())
  updated_at             DateTime               @updatedAt
  email                  String?
  image                  String?
  appointments           Appointment[]
  inventory              BranchInventory[]
  inventory_transactions InventoryTransaction[]
  rooms                  Room[]
  users                  User[]
}

model User {
  id                          String                    @id @default(uuid())
  email                       String?                   @unique
  password_hash               String?
  full_name                   String?
  phone                       String?
  branch_id                   String?
  metadata                    Json?
  created_at                  DateTime                  @default(now())
  updated_at                  DateTime                  @updatedAt
  role                        UserRole                  @default(PATIENT)
  is_active                   Boolean                   @default(true)
  avatar                      String?
  is_verified                 Boolean                   @default(false)
  verification_token          String?
  created_appointments        Appointment[]             @relation("CreatedAppointments")
  conversation_participations ConversationParticipant[]
  doctor                      Doctor?
  sent_messages               Message[]
  patient                     Patient?
  branch                      Branch?                   @relation(fields: [branch_id], references: [id])
  staff_shifts    DoctorShift[]   @relation("StaffShifts")
}

model Patient {
  id                String          @id @default(uuid())
  user_id           String          @unique
  date_of_birth     DateTime?
  address           String?
  emergency_contact Json?
  insurance         Json?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  gender            Gender?
  appointments      Appointment[]
  invoices          Invoice[]
  medical_records   MedicalRecord[]
  user              User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  prescriptions     Prescription[]
}

model Doctor {
  id                String          @id @default(uuid())
  user_id           String          @unique
  code              String?         @unique
  title             String?
  biography         String?
  qualifications    Json?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  average_time      Int             @default(30)
  specialization_id String?
  appointments      Appointment[]   @relation("DoctorAssigned")
  specialization    Specialization? @relation(fields: [specialization_id], references: [id])
  user              User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  shifts            DoctorShift[]
  medical_records   MedicalRecord[]
  prescriptions     Prescription[]
}

model Specialization {
  id          String   @id @default(uuid())
  name        String   @unique

  slug String @default("temp-slug")
  image       String?                     // Link ảnh bìa (Banner)
  icon        String?                     // Icon nhỏ (nếu cần hiển thị menu)
  content     String?  @db.Text           // Bài viết chi tiết (HTML)

  description String?
  doctors     Doctor[]
  rooms       Room[]
  packages    ExaminationPackage[]
}

model ExaminationPackage {
  id                String         @id @default(uuid())
  name              String
  slug              String         @unique @default("temp-slug") // URL thân thiện cho gói khám  
  category          String?                               // Nhóm gói khám (VD: health-check, pre-marriage, dental,...)
  description       String?
  specialization_id String
  price             Decimal        @default(0) @db.Decimal(10, 2)
  original_price    Decimal?       @db.Decimal(10, 2)  // Giá gốc (nếu có giảm giá)
  image             String?        // Ảnh minh họa gói khám
  services          Json?         // Danh sách dịch vụ trong gói (JSON array)
  duration          Int?          // Thời gian khám (phút)
  is_active         Boolean        @default(true)
  is_featured       Boolean        @default(false)  // Gói nổi bật
  created_at        DateTime       @default(now())
  updated_at        DateTime       @updatedAt
  specialization    Specialization @relation(fields: [specialization_id], references: [id], onDelete: Cascade)

  @@index([specialization_id])
  @@index([is_active])
}

model Room {
  id                String          @id @default(uuid())
  name              String
  code              String          @unique
  branch_id         String?
  specialization_id String?
  floor             String?
  capacity          Int             @default(1)
  metadata          Json?
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
  building          String?
  appointments      Appointment[]
  shifts            DoctorShift[]
  branch            Branch?         @relation(fields: [branch_id], references: [id])
  specialization    Specialization? @relation(fields: [specialization_id], references: [id])
}

model DoctorShift {
  id         String   @id @default(uuid())
  doctor_id  String?
  staff_id   String?
  actual_start_time DateTime? 
  actual_end_time   DateTime?
  room_id    String
  start_time DateTime
  end_time   DateTime
  recurrence Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  doctor     Doctor?   @relation(fields: [doctor_id], references: [id])
  staff      User?    @relation("StaffShifts", fields: [staff_id], references: [id])
  room       Room     @relation(fields: [room_id], references: [id])

  
  @@index([room_id, start_time])
  @@index([staff_id, start_time])
}

model Appointment {
  id                 String                 @id @default(uuid())
  patient_id         String
  room_id            String?
  branch_id          String?
  doctor_assigned_id String?
  appointment_type   String?
  start_time         DateTime
  end_time           DateTime
  source             String?
  notes              String?
  created_by         String?
  created_at         DateTime               @default(now())
  updated_at         DateTime               @updatedAt
  status             AppointmentStatus      @default(SCHEDULED)
  branch             Branch?                @relation(fields: [branch_id], references: [id])
  creator            User?                  @relation("CreatedAppointments", fields: [created_by], references: [id])
  doctor             Doctor?                @relation("DoctorAssigned", fields: [doctor_assigned_id], references: [id])
  patient            Patient                @relation(fields: [patient_id], references: [id])
  room               Room?                  @relation(fields: [room_id], references: [id])
  status_logs        AppointmentStatusLog[]
  invoices           Invoice[]
  medical_record     MedicalRecord?
  prescriptions      Prescription[]

  @@index([room_id, start_time])
  @@index([patient_id])
  @@index([branch_id])
}

model MedicalRecord {
  id             String         @id @default(uuid())
  appointment_id String         @unique
  patient_id     String
  doctor_id      String
  diagnosis      String
  symptoms       String?
  clinical_data  Json?
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt
  attachments    Json?          @default("[]")
  appointment    Appointment    @relation(fields: [appointment_id], references: [id])
  doctor         Doctor         @relation(fields: [doctor_id], references: [id])
  patient        Patient        @relation(fields: [patient_id], references: [id])
  prescriptions  Prescription[]
}

model AppointmentStatusLog {
  id             String             @id @default(uuid())
  appointment_id String
  changed_by     String?
  created_at     DateTime           @default(now())
  old_status     AppointmentStatus?
  new_status     AppointmentStatus?
  appointment    Appointment        @relation(fields: [appointment_id], references: [id], onDelete: Cascade)
}

model Prescription {
  id                String             @id @default(uuid())
  appointment_id    String?
  patient_id        String?
  doctor_id         String?
  notes             String?
  created_at        DateTime           @default(now())
  branch_id         String?
  medical_record_id String?
  appointment       Appointment?       @relation(fields: [appointment_id], references: [id])
  doctor            Doctor?            @relation(fields: [doctor_id], references: [id])
  medical_record    MedicalRecord?     @relation(fields: [medical_record_id], references: [id])
  patient           Patient?           @relation(fields: [patient_id], references: [id])
  items             PrescriptionItem[]
}

model PrescriptionItem {
  id              String       @id @default(uuid())
  prescription_id String
  medication_id   String?
  name            String?
  dosage          String?
  frequency       String?
  duration        String?
  instructions    String?
  quantity        Int?         @default(1)
  medication      Medication?  @relation(fields: [medication_id], references: [id])
  prescription    Prescription @relation(fields: [prescription_id], references: [id], onDelete: Cascade)
}

model Medication {
  id                     String                 @id @default(uuid())
  code                   String?                @unique
  is_active              Boolean                @default(true)
  name                   String
  form                   String?
  base_info              Json?
  created_at             DateTime               @default(now())
  base_unit              String                 @default("Viên")
  conversion_factor      Int                    @default(1)
  cost_price             Decimal                @default(0) @db.Decimal(10, 2)
  import_unit            String?                @default("Hộp")
  profit_margin          Float                  @default(0.2)
  sell_price             Decimal                @default(0) @db.Decimal(10, 2)
  inventories            BranchInventory[]
  inventory_transactions InventoryTransaction[]
  items                  PrescriptionItem[]
}

model BranchInventory {
  id               String     @id @default(uuid())
  branch_id        String
  medication_id    String
  quantity         Int        @default(0)
  batch_number     String
  expiry_date      DateTime
  created_at       DateTime   @default(now())
  import_price     Decimal    @default(0) @db.Decimal(10, 2)
  initial_quantity Int
  is_expired       Boolean    @default(false)
  mfg_date         DateTime
  sold_quantity    Int        @default(0)
  updated_at       DateTime   @updatedAt
  pending_quantity Int        @default(0)
  branch           Branch     @relation(fields: [branch_id], references: [id])
  medication       Medication @relation(fields: [medication_id], references: [id])

  @@unique([branch_id, medication_id, batch_number])
}

model Invoice {
  id             String        @id @default(uuid())
  appointment_id String?
  patient_id     String?
  total_amount   Decimal       @default(0) @db.Decimal(10, 2)
  created_at     DateTime      @default(now())
  status         InvoiceStatus @default(UNPAID)
  branch_id      String?
  appointment    Appointment?  @relation(fields: [appointment_id], references: [id])
  patient        Patient?      @relation(fields: [patient_id], references: [id])
  items          InvoiceItem[]
  payments       Payment[]
}

model InvoiceItem {
  id            String   @id @default(uuid())
  invoice_id    String
  description   String?
  amount        Decimal? @db.Decimal(10, 2)
  quantity      Int      @default(1)
  medication_id String?
  invoice       Invoice  @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}

model Payment {
  id             String         @id @default(uuid())
  invoice_id     String
  amount         Decimal        @db.Decimal(10, 2)
  transaction_id String?
  paid_at        DateTime       @default(now())
  method         PaymentMethod?
  invoice        Invoice        @relation(fields: [invoice_id], references: [id])
}

model File {
  id         String   @id @default(uuid())
  owner_id   String?
  owner_type String?
  key        String
  url        String?
  mime_type  String?
  size       Int?
  created_at DateTime @default(now())
}

model Conversation {
  id               String                    @id @default(uuid())
  created_at       DateTime                  @default(now())
  updated_at       DateTime                  @updatedAt
  guest_session_id String?
  status           ConversationStatus        @default(NEW)
  tags             String[]                  @default([])
  GuestSession     GuestSession?             @relation(fields: [guest_session_id], references: [id])
  participants     ConversationParticipant[]
  messages         Message[]
}

model ConversationParticipant {
  conversation_id String
  user_id         String
  joined_at       DateTime     @default(now())
  conversation    Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@id([conversation_id, user_id])
}

model Message {
  id              String        @id @default(uuid())
  conversation_id String
  sender_id       String?
  content         String
  created_at      DateTime      @default(now())
  is_read         Boolean       @default(false)
  type            MessageType   @default(TEXT)
  guest_sender_id String?
  conversation    Conversation  @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  GuestSession    GuestSession? @relation(fields: [guest_sender_id], references: [id])
  sender          User?         @relation(fields: [sender_id], references: [id])
}

model InventoryTransaction {
  id            String          @id @default(uuid())
  branch_id     String
  medication_id String
  type          TransactionType
  quantity      Int
  price         Decimal         @default(0) @db.Decimal(10, 2)
  batch_number  String?
  expiry_date   DateTime?
  reference_id  String?
  note          String?
  created_at    DateTime        @default(now())
  created_by    String?
  branch        Branch          @relation(fields: [branch_id], references: [id])
  medication    Medication      @relation(fields: [medication_id], references: [id])
}

model GuestSession {
  id           String         @id
  name         String?
  phone        String?
  email        String?
  created_at   DateTime       @default(now())
  updated_at   DateTime
  Conversation Conversation[]
  Message      Message[]
}

enum UserRole {
  ADMIN
  DOCTOR
  PATIENT
  RECEPTIONIST
  BRANCH_MANAGER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum InvoiceStatus {
  UNPAID
  PAID
  PARTIALLY_PAID
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

enum TransactionType {
  IMPORT
  EXPORT
  ADJUSTMENT
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}

enum ConversationStatus {
  NEW
  IN_PROGRESS
  COMPLETED
}

model News {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique @default("temp-slug")
  excerpt     String?  @db.Text
  content     String?  @db.Text
  author      String?
  category    String?
  image       String?
  views       Int      @default(0)
  is_published Boolean @default(false)
  published_at DateTime?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([slug])
  @@index([is_published])
  @@index([category])
}
