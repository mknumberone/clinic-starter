
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String
  full_name     String?
  phone         String?
  role          String
  metadata      Json?
  patients      Patient?
  doctors       Doctor?
  appointments  Appointment[] @relation("CreatedAppointments")
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

model Patient {
  id         String   @id @default(uuid())
  user_id    String   @unique
  user       User     @relation(fields: [user_id], references: [id])
  date_of_birth DateTime?
  gender     String?
  address    String?
  emergency_contact Json?
  insurance  Json?
  appointments Appointment[]
  prescriptions Prescription[]
  invoices   Invoice[]
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Doctor {
  id         String   @id @default(uuid())
  user_id    String   @unique
  user       User     @relation(fields: [user_id], references: [id])
  code       String?  @unique
  title      String?
  biography  String?
  qualifications Json?
  shifts     DoctorShift[]
  appointments Appointment[] @relation("DoctorAssigned")
  prescriptions Prescription[]
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Specialization {
  id     String @id @default(uuid())
  name   String @unique
  description String?
  rooms  Room[]
}

model Room {
  id               String   @id @default(uuid())
  name             String
  code             String   @unique
  specialization_id String?
  specialization   Specialization? @relation(fields: [specialization_id], references: [id])
  floor            String?
  capacity         Int      @default(1)
  metadata         Json?
  shifts           DoctorShift[]
  appointments     Appointment[]
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
}

model DoctorShift {
  id         String   @id @default(uuid())
  doctor_id  String
  room_id    String
  doctor     Doctor   @relation(fields: [doctor_id], references: [id])
  room       Room     @relation(fields: [room_id], references: [id])
  start_time DateTime
  end_time   DateTime
  recurrence Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([doctor_id, start_time, end_time])
  @@index([room_id, start_time])
}

model Appointment {
  id                 String    @id @default(uuid())
  patient_id         String?
  room_id            String?
  doctor_assigned_id String?
  appointment_type   String?
  start_time         DateTime
  end_time           DateTime
  status             String    @default("scheduled")
  source             String?
  notes              String?
  created_by         String?
  patient            Patient?  @relation(fields: [patient_id], references: [id])
  room               Room?     @relation(fields: [room_id], references: [id])
  doctor             Doctor?   @relation("DoctorAssigned", fields: [doctor_assigned_id], references: [id])
  creator            User?     @relation("CreatedAppointments", fields: [created_by], references: [id])
  status_logs        AppointmentStatusLog[]
  prescriptions      Prescription[]
  invoices           Invoice[]
  created_at         DateTime   @default(now())
  updated_at         DateTime   @updatedAt

  @@index([room_id, start_time])
  @@index([patient_id])
}

model AppointmentStatusLog {
  id             String    @id @default(uuid())
  appointment_id String
  appointment    Appointment @relation(fields: [appointment_id], references: [id])
  old_status     String?
  new_status     String?
  changed_by     String?
  created_at     DateTime @default(now())
}

model Prescription {
  id             String   @id @default(uuid())
  appointment_id String?
  patient_id     String?
  doctor_id      String?
  notes          String?
  appointment    Appointment? @relation(fields:[appointment_id], references:[id])
  patient        Patient? @relation(fields:[patient_id], references:[id])
  doctor         Doctor? @relation(fields:[doctor_id], references:[id])
  items          PrescriptionItem[]
  created_at     DateTime @default(now())
}

model PrescriptionItem {
  id              String   @id @default(uuid())
  prescription_id String
  medication_id   String?
  name            String?
  dosage          String?
  frequency       String?
  duration        String?
  instructions    String?
  prescription    Prescription @relation(fields:[prescription_id], references:[id])
  medication      Medication? @relation(fields:[medication_id], references:[id])
}

model Medication {
  id        String @id @default(uuid())
  code      String? @unique
  name      String
  form      String?
  base_info Json?
  items     PrescriptionItem[]
  created_at DateTime @default(now())
}

model Invoice {
  id             String     @id @default(uuid())
  appointment_id String?
  patient_id     String?
  total_amount   Float       @default(0)
  status         String      @default("unpaid")
  appointment    Appointment? @relation(fields:[appointment_id], references:[id])
  patient        Patient? @relation(fields:[patient_id], references:[id])
  items          InvoiceItem[]
  payments       Payment[]
  created_at     DateTime @default(now())
}

model InvoiceItem {
  id          String @id @default(uuid())
  invoice_id  String
  description String?
  amount      Float?
  quantity    Int     @default(1)
  invoice     Invoice @relation(fields:[invoice_id], references:[id])
}

model Payment {
  id             String @id @default(uuid())
  invoice_id     String
  amount         Float
  method         String?
  transaction_id String?
  paid_at        DateTime @default(now())
  invoice        Invoice @relation(fields:[invoice_id], references:[id])
}

model File {
  id         String @id @default(uuid())
  owner_id   String?
  owner_type String?
  key        String
  url        String?
  mime_type  String?
  size       Int?
  created_at DateTime @default(now())
}
